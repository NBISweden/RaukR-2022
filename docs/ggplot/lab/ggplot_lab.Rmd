---
title: "ggplot2: Beyond the Basics"
subtitle: "RaukR 2021 â€¢ Advanced R for Bioinformatics"
author: "Roy Francis"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: united
    highlight: textmate
    df_print: paged
    code_folding: none
    self_contained: false
    keep_md: false
    encoding: "UTF-8"
    css: ["assets/lab.css"]
---

```{r,echo=FALSE,child="assets/header-lab.Rmd"}
```

<!-- ------------ Only edit title, subtitle & author above this ------------ -->

<br>
<div class="abstract spaced">
This are practical exercises to compliment the lecture on **ggplot2: Beyond the Basics**. Attempt to solve the questions yourselves. If not, click the button to reveal the solution. There are likely multiple ways to solve the question. Answers mostly use functions from `ggplot2`, `dplyr` and `tidyr`. Additional packages are used occasionally.
</div>
<br>

```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(GGally)
library(ggrepel)
library(ggnewscale)
library(patchwork)
```

# Penguins
## Install data

Install the penguins data set from [palmerpenguins](https://allisonhorst.github.io/palmerpenguins/).

```{r,eval=FALSE}
install.packages("palmerpenguins")
```

![](https://allisonhorst.github.io/palmerpenguins/reference/figures/lter_penguins.png)

```{r}
library(palmerpenguins)
data(penguins)
```

Inspect the data set and make sure that the data types are correct and that you understand what the different variables are.

```{r}
head(penguins)
str(penguins)
```

## Body mass and species

<i class='fa fa-clipboard-list'></i> Is it possible to differentiate the penguin species based on body mass alone? What kind of plot would you use?

```{r,fig.height=3,fig.width=7,accordion=TRUE}
ggplot(penguins,aes(species,body_mass_g,col=species))+
  geom_violin()
```

## All measurements and species

<i class='fa fa-clipboard-list'></i> Are there any single continuous variable in this data set that can differentiate species? How would you visually explore this? What kind of plot would you use?

```{r,fig.height=4,fig.width=7,accordion=TRUE}
penguins %>% 
  tidyr::pivot_longer(where(is.numeric),names_to="metric",values_to="value") %>%
  ggplot(aes(species,value,col=species))+
    geom_violin()+
    facet_wrap(~metric,scales="free")
```

## Bivariate scatterplots

<i class='fa fa-clipboard-list'></i> Perhaps it's easier to differentiate species based on two variables. Create pairwise scatterplots between all numeric variables and colour by species.  
<i class='fa fa-lightbulb'></i> This can be done using  `ggplot2` alone, but in this example, we use a ggplot2 extension package [`GGally`](https://ggobi.github.io/ggally/). This is similar to the base R function `pairs()`.

```{r,fig.height=7,fig.width=7,accordion=TRUE}
select(penguins,species,bill_length_mm,bill_depth_mm,flipper_length_mm,body_mass_g) %>%
GGally::ggpairs(mapping = ggplot2::aes(color=species))
```

<i class='fa fa-comments'></i> Which two variables do you think best differentiates the species?

## Bill length & bill depth

<i class='fa fa-clipboard-list'></i> Create a scatterplot of bill length on x axis and bill depth on y axis. 

```{r,fig.height=3,fig.width=7,accordion=TRUE}
p <- ggplot(penguins,aes(bill_length_mm,bill_depth_mm))+
  geom_point()
p
```

<i class='fa fa-clipboard-list'></i> Draw a regression line to denote the relationship between bill length and bill depth.

```{r,fig.height=3,fig.width=7,accordion=TRUE}
p+geom_smooth(method="lm")
```

<i class='fa fa-comments'></i> What is the relationship between these two variables? 

<i class='fa fa-clipboard-list'></i> Recreate the previous figure and colour the points by species.

```{r,fig.height=3,fig.width=7,accordion=TRUE}
p <- ggplot(penguins,aes(bill_length_mm,bill_depth_mm,col=species))+
  geom_point()+
  geom_smooth(method="lm")
p
```

<i class='fa fa-comments'></i> What is the relationship between these two variables now? 

<i class='fa fa-clipboard-list'></i> Change the colours of the categories to these three custom colours: `c("#E69F00","#56B4E9","#009E73")`. Change the legend title from "species" to "Species" and in bold font face.

```{r,fig.height=3,fig.width=7,accordion=TRUE}
p <- p+scale_colour_manual(name="Species",values=c("#E69F00","#56B4E9","#009E73"))+
  theme(legend.title = element_text(face="bold"))
p
```

<i class='fa fa-clipboard-list'></i> Position the legend within the plot area as shown.

```{r,fig.height=4,fig.width=7,echo=FALSE}
p <- p+theme(legend.position=c(0.90,0.18))
p
```

```{r,fig.height=3,fig.width=7,accordion=TRUE,eval=FALSE}
p <- p+theme(legend.position=c(0.90,0.18))
# legend justification can be set similarly
# legend.justification=c(0,1)
```

<i class='fa fa-clipboard-list'></i> Disable the legend, but keep the point colours.

```{r,fig.height=4,fig.width=7,accordion=TRUE}
p+theme(legend.position="none")
```

## Geographical distribution

<i class='fa fa-clipboard-list'></i> What is the geographical distribution of the species? Create a plot to illustrate this.

```{r,fig.height=4,fig.width=7,accordion=TRUE}
ggplot(penguins,aes(species,island,color=species))+
  geom_jitter()
```

# Gapminder

Install and attach the gapminder package.

```{r}
library(gapminder)
g <- gapminder
```

Inspect the data set and make sure the data types are correct and that you understand what these variables are.

```{r}
head(g)
str(g)
```

<i class='fa fa-clipboard-list'></i> How has the global life expectancy changed over time? What trend do you observe? Create a scatterplot of life expectancy over time and add a trend line.

```{r,fig.height=4,fig.width=7,accordion=TRUE}
ggplot(g,aes(year,lifeExp))+
  geom_point()+
  geom_smooth(method="lm")
```

<i class='fa fa-clipboard-list'></i> Does the life expectancy trend you previously identified, differ across continents?

```{r,fig.height=4,fig.width=7,accordion=TRUE}
ggplot(g,aes(year,lifeExp,col=continent))+
  geom_point()+
  geom_smooth(method="lm")
```

<i class='fa fa-clipboard-list'></i> Which continent has the highest variation in life expectancy in 2007?

```{r,fig.height=4,fig.width=7,accordion=TRUE}
g %>%
  filter(year=="2007") %>%
  group_by(continent) %>%
  summarise(variance=var(lifeExp),sd=sd(lifeExp),diff=max(lifeExp)-min(lifeExp))
```


```{r,fig.height=4,fig.width=7,accordion=TRUE}
filter(g,year=="2007") %>%
  ggplot(aes(x=lifeExp))+
  geom_histogram()+
  facet_wrap(~continent)
```

<i class='fa fa-clipboard-list'></i> Which are the top 10 countries by GDP per capita in 2007? Create a horizontal barplot.

```{r,fig.height=5,fig.width=7,accordion=TRUE}
g %>%
  filter(year=="2007") %>%
  slice_max(order_by=gdpPercap,n=10) %>%
  ggplot(aes(x=reorder(country,gdpPercap),y=gdpPercap))+
  geom_col()+
  coord_flip()
```

<i class='fa fa-clipboard-list'></i> Create a plot of the top 5 countries in each continent with the highest life expectancy in 2007 facetted by continent.

```{r,fig.height=5,fig.width=7,accordion=TRUE}
g %>%
  filter(year=="2007") %>%
  group_by(continent) %>%
  slice_max(order_by=lifeExp,n=5) %>%
  ggplot(aes(x=reorder(country,-lifeExp),y=lifeExp))+
  geom_col()+
  facet_wrap(~continent,scales="free")+
  theme(axis.text.x = element_text(angle=45,hjust=1))
```

<i class='fa fa-clipboard-list'></i> Create a plot of the top 10 countries in each continent with the highest change in life expectancy between 1952 and 2007, facetted by continent.

```{r,fig.height=5,fig.width=7,accordion=TRUE,eval=F}
g %>%
  filter(year %in% c("1952","2007")) %>%
  select(year,country,continent,lifeExp) %>%
  pivot_wider(names_from="year",values_from="lifeExp") %>%
  mutate(diff=`2007`-`1952`) %>%
  group_by(continent) %>%
  slice_max(order_by=diff,n=10) %>%
  ggplot(aes(x=reorder(country,diff)))+
  geom_segment(aes(xend=reorder(country,diff),y=`1952`,yend=`2007`,group=country),size=0.7,colour="grey60")+
  geom_point(aes(y=`1952`),colour="firebrick")+
  geom_point(aes(y=`2007`),colour="steelblue")+
  facet_wrap(~continent,scales="free_y")+
  labs(x=NULL,y="Life expectancy (years)")+
  coord_flip()+
  theme(axis.text.x = element_text(angle=45,hjust=1))
```

## Life expectancy & GDP

<i class='fa fa-clipboard-list'></i> What is the relationship between life expectancy and GDP per capita?

```{r,fig.height=4,fig.width=7,accordion=TRUE}
ggplot(g,aes(gdpPercap,lifeExp))+
  geom_point()+
  scale_x_log10()+
  geom_smooth(method="lm")
```

<i class='fa fa-clipboard-list'></i> Using the same plot, filter to keep only values for the year 2007, remove the regression line, colour the points by continent and map the size of points to population.

```{r,fig.height=4,fig.width=7,accordion=TRUE}
filter(g,year=="2007") %>%
ggplot(aes(gdpPercap,lifeExp,size=pop,col=continent))+
  geom_point()+
  scale_x_log10()
```

<i class='fa fa-clipboard-list'></i> Annotate/label the following countries on the plot: United states, China, Oman
<i class='fa fa-lightbulb'></i> You can use for example; `geom_label()` or `annotate()`, but in this example, `ggrepel::geom_text_repel()` is used.

```{r,fig.height=4,fig.width=7,accordion=TRUE}
f <- filter(g,year=="2007",country %in% c("China","Oman","United States"))

filter(g,year=="2007") %>%
ggplot(aes(gdpPercap,lifeExp,col=continent))+
  geom_point(aes(size=pop))+
  ggrepel::geom_text_repel(data=f,aes(label=country),point.padding =15,min.segment.length=0)+
  scale_x_log10()
```

<i class='fa fa-clipboard-list'></i> Colour the three highlighted countries (point and label) in new colours.
<i class='fa fa-lightbulb'></i> This is an example that uses multiple colour scales using the `ggnewscale()` package.

```{r,fig.height=6,fig.width=7,accordion=TRUE}
f <- filter(g,year=="2007",country %in% c("China","Oman","United States"))

filter(g,year=="2007") %>%
ggplot(aes(gdpPercap,lifeExp))+
  geom_point(aes(size=pop,col=continent))+
  ggnewscale::new_scale_color()+
  ggnewscale::new_scale_fill()+
  geom_point(data=f,aes(col=country,size=pop))+
  ggrepel::geom_text_repel(data=f,aes(label=country,col=country),point.padding =15,min.segment.length=0,fontface="bold")+
  scale_x_log10()+
  scale_colour_brewer(type="qual")
```

<i class='fa fa-clipboard-list'></i> Try to customise the plot for production similar to that shown below.

```{r,fig.height=5,fig.width=7,echo=FALSE}
f <- filter(g,year=="2007",country %in% c("China","Oman","United States"))

filter(g,year=="2007") %>%
ggplot(aes(gdpPercap,lifeExp))+
  geom_point(aes(size=pop,col=continent))+
  scale_size_continuous(name="Population",
                        breaks=c(10^6,10*10^6,100*10^6,500*10^6,1000*10^6),
                        labels=c("1M","10M","100M","500M","1B"))+
  scale_color_brewer(name="Continent",type="qual",palette=4)+
  scale_x_log10(labels=scales::dollar_format(accuracy=1))+
  ggnewscale::new_scale_color()+
  ggnewscale::new_scale_fill()+
  geom_point(data=f,aes(col=country,size=pop),show.legend=FALSE)+
  ggrepel::geom_text_repel(data=f,aes(label=country,col=country),point.padding =15,min.segment.length=0,fontface="bold",show.legend=FALSE)+

  scale_color_manual(values=rev(c("#56B4E9","#009E73","#F0E442","#0072B2","#D55E00")))+
  labs(x="GDP per capita (Log scale)",y="Life expectancy (years)")+
  theme_bw()+
  theme(panel.border = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(colour="grey30"),
        axis.text = element_text(colour="grey30"),
        axis.title = element_text(colour="grey30"),
        legend.text = element_text(colour="grey30"),
        plot.title = element_text(colour="grey30"),
        strip.text = element_text(colour="grey30"))
```

The changes made are as follows:

- Legend titles, legend text and axes labels are improved
- X axis text is dollar formatted
- Custom colours are used for continents and highlighted points
- Theme is changed
- Panel border and minor gridlines are removed
- Axes tick marks are removed
- Text colour is lighter to decrease contrast

```{r,fig.height=5,fig.width=7,eval=FALSE,accordion=TRUE}
f <- filter(g,year=="2007",country %in% c("China","Oman","United States"))

filter(g,year=="2007") %>%
ggplot(aes(gdpPercap,lifeExp))+
  geom_point(aes(size=pop,col=continent))+
  scale_size_continuous(name="Population",
                        breaks=c(10^6,10*10^6,100*10^6,500*10^6,1000*10^6),
                        labels=c("1M","10M","100M","500M","1B"))+
  scale_color_brewer(name="Continent",type="qual",palette=4)+
  scale_x_log10(labels=scales::dollar_format(accuracy=1))+
  ggnewscale::new_scale_color()+
  ggnewscale::new_scale_fill()+
  geom_point(data=f,aes(col=country,size=pop),show.legend=FALSE)+
  ggrepel::geom_text_repel(data=f,aes(label=country,col=country),point.padding =15,min.segment.length=0,fontface="bold",show.legend=FALSE)+

  scale_color_manual(values=rev(c("#56B4E9","#009E73","#F0E442","#0072B2","#D55E00")))+
  labs(x="GDP per capita (Log scale)",y="Life expectancy (years)")+
  theme_bw()+
  theme(panel.border = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(colour="grey30"),
        axis.text = element_text(colour="grey30"),
        axis.title = element_text(colour="grey30"),
        legend.text = element_text(colour="grey30"),
        plot.title = element_text(colour="grey30"),
        strip.text = element_text(colour="grey30"))
```

## Subplots & facetting

<i class='fa fa-clipboard-list'></i> Create a scatterplot of GDP per capita on the x axis and life expectancy on the y axis. Facet by continent.

```{r,fig.height=4,fig.width=7,accordion=TRUE}
ggplot(g,aes(gdpPercap,lifeExp))+
  geom_point()+
  scale_x_log10()+
  facet_wrap(~continent)
```

<i class='fa fa-clipboard-list'></i> Add the full data in the background (as light grey points) for reference.

```{r,fig.height=4,fig.width=7,accordion=TRUE}
ggplot(g,aes(gdpPercap,lifeExp))+
  geom_point(data=select(g,-continent),col="grey80")+
  geom_point()+
  scale_x_log10()+
  facet_wrap(~continent)
```

<i class='fa fa-clipboard-list'></i> Highlight the countries China and Oman on this plot. Connect these points as a line.

```{r,fig.height=4,fig.width=7,accordion=TRUE}
ggplot(g,aes(gdpPercap,lifeExp))+
  geom_point(data=select(g,-continent),col="grey80")+
  geom_point()+
  geom_line(data=filter(g,country %in% c("China","Oman")),aes(col=country))+
  scale_x_log10()+
  facet_wrap(~continent)
```

<i class='fa fa-clipboard-list'></i> Customise the plot to production quality as shown below.

```{r,fig.height=5,fig.width=7,echo=FALSE}
ggplot(g,aes(gdpPercap,lifeExp))+
  geom_point(data=select(g,-continent),col="grey80",alpha=0.4)+
  geom_point(alpha=0.7)+
  geom_line(data=filter(g,country %in% c("China","Oman")),aes(col=country))+
  scale_x_log10(labels=scales::dollar_format(accuracy=1))+
  facet_wrap(~continent)+
  labs(x="GDP per capita (Log scale))",y="Life expectancy (years)",title="")+
  theme_bw()+
  theme(panel.border = element_blank(),
        panel.grid = element_blank(),
        strip.background = element_blank(),
        axis.ticks = element_blank(),
        legend.position="top",
        legend.justification="right",
        legend.title = element_blank(),
        axis.text = element_text(colour="grey30"),
        axis.title = element_text(colour="grey30"),
        legend.text = element_text(colour="grey30"),
        plot.title = element_text(colour="grey30"),
        strip.text = element_text(colour="grey30"))
```

The changes made as as follows:

- X axis uses dollar formatting
- Axes labels are improved
- Axes tick marks are removed
- Panel border and gridlines are removed
- Strip panels are simplified
- Legend position is moved to top right
- Legend title is removed
- Theme is changed
- Text colour is lighter to decrease contrast

```{r,fig.height=5,fig.width=7,accordion=TRUE,eval=FALSE}
ggplot(g,aes(gdpPercap,lifeExp))+
  geom_point(data=select(g,-continent),col="grey80",alpha=0.4)+
  geom_point(alpha=0.7)+
  geom_line(data=filter(g,country %in% c("China","Oman")),aes(col=country))+
  scale_x_log10(labels=scales::dollar_format(accuracy=1))+
  facet_wrap(~continent)+
  labs(x="GDP per capita (Log scale))",y="Life expectancy (years)",title="")+
  theme_bw()+
  theme(panel.border = element_blank(),
        panel.grid = element_blank(),
        strip.background = element_blank(),
        axis.ticks = element_blank(),
        legend.position="top",
        legend.justification="right",
        legend.title = element_blank(),
        axis.text = element_text(colour="grey30"),
        axis.title = element_text(colour="grey30"),
        legend.text = element_text(colour="grey30"),
        plot.title = element_text(colour="grey30"),
        strip.text = element_text(colour="grey30"))
```

## Africa life expectancy heatmap

<i class='fa fa-clipboard-list'></i> Create a heatmap of life expectancy over time for African countries.

```{r,fig.height=6,fig.width=7}
g %>%
  filter(continent=="Africa") %>%
  ggplot(aes(year,country,fill=lifeExp))+
  geom_tile()
```

<i class='fa fa-clipboard-list'></i> Order the countries by similar trends.
<i class='fa fa-lightbulb'></i> This is tricky. You need to cluster by rows. You can use the function `hclust()` to perform the clustering, but the data needs to be reformatted to be suitable as input.

```{r,fig.height=6,fig.width=7}
g1 <- filter(na.omit(g),continent=="Africa")

# clustering
g2 <- g1 %>%
      select(country,year,lifeExp) %>%
      pivot_wider(names_from="year",values_from="lifeExp") %>%
      tibble::column_to_rownames("country")
cn <- rownames(g2)[hclust(dist(g2))$order]

g1 %>%
  mutate(country=factor(as.character(country),levels=cn)) %>%
  ggplot(aes(year,country,fill=lifeExp))+
  geom_tile()
```

<i class='fa fa-clipboard-list'></i> Customise the heatmap to production quality as shown below:

```{r,fig.height=7,fig.width=7,echo=FALSE}
cols <- viridisLite::viridis(n=10)

g1 <- filter(na.omit(g),continent=="Africa")

# clustering
g2 <- g1 %>%
      select(country,year,lifeExp) %>%
      pivot_wider(names_from="year",values_from="lifeExp") %>%
      tibble::column_to_rownames("country")
cn <- rownames(g2)[hclust(dist(g2))$order]

g1 %>%
  mutate(country=factor(as.character(country),levels=cn)) %>%
  ggplot(aes(year,country,fill=lifeExp))+
  geom_tile(colour="white")+
  labs(x=NULL,y=NULL,title="Africa: Life expectancy",subtitle="1952 - 2007")+
  scale_y_discrete(expand=c(0,0))+
  scale_x_continuous(expand=c(0,0),breaks=unique(g1$year))+
  scale_fill_gradientn(name=NULL,colors=cols,na.value="grey95",
                       guide=guide_colourbar(barheight=.5,barwidth=10,
                                             label.position="top"))+
  scale_y_discrete(breaks=cn)+
  theme(legend.position=c(1,1.035),
        legend.justification="right",
        legend.direction="horizontal",
        plot.title = element_text(face="bold"),
        plot.margin=unit(c(1.3,0.5,0.5,0.5),"cm"))
```

The following adjustments have been made:

- Custom colour palette is used
- Title and subtitle is added
- X axis shows all years for which the data is available
- X and Y axes labels are hidden and bold title is added
- The colour bar legend is slimmer, horizontal and added to the top right
- Plot margin is increased on the top

```{r,fig.height=8,fig.width=7,accordion=TRUE,eval=FALSE}
cols <- viridisLite::viridis(n=10)

g1 <- filter(na.omit(g),continent=="Africa")

# clustering
g2 <- g1 %>%
      select(country,year,lifeExp) %>%
      pivot_wider(names_from="year",values_from="lifeExp") %>%
      tibble::column_to_rownames("country")
cn <- rownames(g2)[hclust(dist(g2))$order]

g1 %>%
  mutate(country=factor(as.character(country),levels=cn)) %>%
  ggplot(aes(year,country,fill=lifeExp))+
  geom_tile(colour="white")+
  labs(x=NULL,y=NULL,title="Africa: Life expectancy",subtitle="1952 - 2007")+
  scale_y_discrete(expand=c(0,0))+
  scale_x_continuous(expand=c(0,0),breaks=unique(g1$year))+
  scale_fill_gradientn(name=NULL,colors=cols,na.value="grey95",
                       guide=guide_colourbar(barheight=.5,barwidth=10,
                                             label.position="top"))+
  scale_y_discrete(breaks=cn)+
  theme(legend.position=c(1,1.035),
        legend.justification="right",
        legend.direction="horizontal",
        plot.title = element_text(face="bold"),
        plot.margin=unit(c(1.3,0.5,0.5,0.5),"cm"))
```

<i class='fa fa-clipboard-list'></i> The fill colour is continuous. Change this to a categorical scale with 5 levels `c("L","LM","M","MH","H")`. And use the following fill colours: `c("#fc8d59","#fee090","#e0f3f8","#91bfdb","#4575b4")`. 

```{r,fig.height=8,fig.width=7,accordion=TRUE}
cols <- c("#fc8d59","#fee090","#e0f3f8","#91bfdb","#4575b4")

g1 <- filter(na.omit(g),continent=="Africa")

# clustering
g2 <- g1 %>%
      select(country,year,lifeExp) %>%
      pivot_wider(names_from="year",values_from="lifeExp") %>%
      tibble::column_to_rownames("country")
cn <- rownames(g2)[hclust(dist(g2))$order]

g1 %>%
  mutate(country=factor(as.character(country),levels=cn),
         lifeExp=cut(lifeExp,breaks=5,labels=c("L","LM","M","MH","H"))) %>%
  ggplot(aes(year,country,fill=lifeExp))+
  geom_tile(colour="white")+
  labs(x=NULL,y=NULL,title="Africa: Life expectancy",subtitle="1952 - 2007")+
  scale_y_discrete(expand=c(0,0))+
  scale_x_continuous(expand=c(0,0),breaks=unique(g1$year))+
  scale_fill_manual(name=NULL,values=cols,na.value="grey95")+
  scale_y_discrete(breaks=cn)+
  theme(legend.position=c(1,1.035),
        legend.justification="right",
        legend.direction="horizontal",
        plot.title = element_text(face="bold"),
        plot.margin=unit(c(1.3,0.5,0.5,0.5),"cm"),
        legend.key.size=unit(0.4,"cm"))
```

<i class='fa fa-comment'></i> Does this make it easier to interpret the information?

## Population and GDP

<i class='fa fa-clipboard-list'></i>  Create a line graph showing mean population in each continent over time. Colour the lines by continent.

```{r,fig.height=4,fig.width=7,accordion=TRUE}
g %>%
  group_by(year,continent) %>%
  summarise(mean=mean(pop)) %>%
  ggplot(aes(x=year,y=mean,col=continent))+
  geom_line()
```

<i class='fa fa-clipboard-list'></i>  What is the relationship between GDP per capita and population?

```{r,fig.height=4,fig.width=7,accordion=TRUE}
g %>%
ggplot(aes(gdpPercap,pop))+
  geom_point(show.legend=FALSE)+
  geom_smooth(method="lm")+
  scale_x_log10()+
  scale_y_log10()
```

<i class='fa fa-clipboard-list'></i> What happens if you look at this relationship by country? Colour by continent and save the plot to a variable `p1`.

```{r,fig.height=4,fig.width=7,accordion=TRUE}
p1 <- g %>%
ggplot(aes(gdpPercap,pop,group=country,col=continent))+
  geom_point(show.legend=FALSE)+
  geom_smooth(method="lm",show.legend=F)+
  scale_x_log10()+
  scale_y_log10()
p1
```

<i class='fa fa-clipboard-list'></i> Calculate the correlation and slope of these relationships for each country. Use log10 scale for both metrics.

```{r,fig.height=4,fig.width=7,accordion=TRUE}
g1 <- g %>%
  mutate(gdpPercap=log10(gdpPercap),pop=log10(pop)) %>%
  group_by(continent,country) %>%
  summarise(cor=cor(gdpPercap,pop,method="spearman"),
            slope=as.numeric(lm(pop~gdpPercap,cur_data())$coefficients[2]))
head(g1)
```

<i class='fa fa-clipboard-list'></i> Create a scatterplot between correlation and slope. Colour by continent. Save this plot to a variable `p2`.

```{r,fig.height=4,fig.width=7,accordion=TRUE}
p2 <- ggplot(g1,aes(cor,slope,col=continent))+
  geom_point()
p2
```

<i class='fa fa-comment'></i> Are there any interesting insights from this plot? What can you infer?

<i class='fa fa-clipboard-list'></i> Can you summarise these messy results? What is the most common direction and strength of relationship between population and GDP per capita across countries? Is this trend consistent by continent? These are not plots.

```{r,accordion=TRUE}
g1 %>%
  ungroup() %>%
  summarise(median_cor=median(cor),median_slope=median(abs(slope)))
```

```{r,accordion=TRUE}
g1 %>%
  group_by(continent) %>%
  summarise(median_cor=median(cor),median_slope=median(abs(slope)))
```

<i class='fa fa-clipboard-list'></i>  Combine the two previously saved plots `p1` and `p2` side by side using `patchwork`. Explore how these commands differ.

```{r,eval=FALSE}
p1+p2
p1|p2
p1/p2
wrap_plots(p1,p2)
```

```{r,fig.height=4,fig.width=7,echo=FALSE}
p1+p2
```

<i class='fa fa-clipboard-list'></i>  How would you move the legend to the top center and horizontal so that it is shared between the two plots?

```{r,fig.height=4,fig.width=7,accordion=TRUE}
wrap_plots(p1,p2,guides="collect")&
  theme(legend.position="top",
        legend.direction="horizontal")
```

<!-- --------------------- Do not edit this and below ---------------------- -->

```{r,echo=FALSE,child="assets/footer-lab.Rmd"}
```

```{r,eval=FALSE,echo=FALSE}
# manually run this to render this document to HTML
rmarkdown::render("ggplot_lab.Rmd")
# manually run this to convert HTML to PDF
#pagedown::chrome_print("lab.html",output="lab.pdf")
```
